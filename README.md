# DETR (DEtection TRansformer) Visualization Application

🎯 **End-to-End Object Detection with Transformers** のStreamlit可視化アプリケーション

## 📋 概要

このアプリケーションは、DETR（DEtection TRansformer）モデルの可視化と分析を行うためのインタラクティブなWebアプリケーションです。DETRは、Transformerアーキテクチャを使用した革新的な物体検知モデルで、従来の手法とは異なるアプローチを採用しています。

### 🎯 主な機能

- **🤖 モデル管理**: 複数のDETRモデル（ResNet-50/101、Panoptic Segmentation）をサポート
- **🎯 物体検知**: リアルタイム物体検知とバウンディングボックス可視化
- **🔍 アテンション可視化**: Transformerのアテンション機構の詳細分析
- **📊 クエリ分析**: オブジェクトクエリの動作と予測の可視化
- **🏗️ アーキテクチャ**: DETRの構造と処理フローの図解
- **📈 内部状態**: 隠れ状態とアテンション重みの詳細分析
- **⚙️ デバッグ情報**: モデル情報、システム情報、メモリ使用量の詳細表示

## 🏗️ アーキテクチャ

```
detr_app/
├── app.py                 # メインStreamlitアプリケーション
├── src/
│   ├── detr_model.py      # DETRモデルマネージャー
│   └── sample_images.py   # サンプル画像管理
├── tests/                 # テストファイル
├── data/                  # データディレクトリ
├── models/                # 保存されたモデル
├── samples/               # サンプル画像
├── pyproject.toml         # プロジェクト設定
└── README.md             # このファイル
```

## 🚀 インストール

### 前提条件

- Python 3.8以上
- PyTorch 2.0以上
- Transformers 4.30.0以上
- CUDA対応GPU（推奨）

### インストール手順

1. **リポジトリのクローン**
```bash
git clone <repository-url>
cd detr_app
```

2. **依存関係のインストール**

**uvを使用（推奨）:**
```bash
uv sync
```

**pipを使用:**
```bash
pip install -r requirements.txt
```

3. **アプリケーションの起動**
```bash
uv run streamlit run app.py --server.port 8504
```

または

```bash
streamlit run app.py --server.port 8504
```

## 📖 使用方法

### 1. モデルの読み込み

1. サイドバーの「🤖 モデル設定」セクションで以下を設定：
   - **DETRモデル**: ResNet-50/101、Panoptic Segmentationから選択
   - **タスク**: 物体検知またはセグメンテーション
   - **信頼度閾値**: 0.1-0.9の範囲で設定

2. 「モデルを読み込み」ボタンをクリック

### 2. 画像の選択

1. **サンプル画像**: サイドバーの「🖼️ 画像選択」でサンプル画像をダウンロード・選択
2. **画像アップロード**: 独自の画像ファイルをアップロード
3. **合成画像**: テスト用の合成画像を生成

### 3. 分析の実行

#### 🎯 物体検知タブ
- **物体検知**: 画像内の物体を検知し、バウンディングボックスを表示
- **検知統計**: 検知数、信頼度、クラス分布の表示
- **検知詳細**: 各検知結果の詳細情報

#### 🔍 アテンション可視化タブ
- **アテンションマップ**: エンコーダー、デコーダー、クロスアテンションの可視化
- **レイヤー選択**: 特定のTransformer層のアテンションを分析
- **統計情報**: アテンション重みの分布と統計

#### 📊 クエリ分析タブ
- **クエリ動作**: 100個のオブジェクトクエリの動作分析
- **信頼度分布**: クエリ別の信頼度分布
- **クラス予測**: 各クエリのクラス予測結果

#### 🏗️ アーキテクチャタブ
- **構造図**: DETRのアーキテクチャ図
- **技術説明**: 各コンポーネントの詳細説明
- **モデル設定**: 現在のモデルの設定情報

#### 📈 内部状態タブ
- **隠れ状態**: エンコーダー・デコーダーの隠れ状態分析
- **活性化統計**: 層別の活性化統計
- **状態変化**: 層間での状態変化の可視化

#### ⚙️ デバッグ情報タブ
- **モデル情報**: 詳細なモデル設定とパラメータ数
- **システム情報**: PyTorch、CUDA、GPU情報
- **メモリ使用量**: GPUメモリの詳細
- **生データ**: 検知結果とアテンションマップの生データ

## 🔧 技術仕様

### DETRアーキテクチャ

DETRは以下の主要コンポーネントで構成されています：

1. **CNNバックボーン (ResNet-50/101)**
   - 入力画像: `(3, H, W)`
   - 出力特徴マップ: `(2048, H/32, W/32)`
   - 投影層: `(256, H/32, W/32)`

2. **Transformerエンコーダー**
   - 6層の自己アテンション層
   - 隠れサイズ: 256
   - アテンションヘッド数: 8
   - 位置エンコーディング: 正弦波

3. **Transformerデコーダー**
   - 6層のデコーダー層
   - オブジェクトクエリ: 100個
   - クロスアテンション: エンコーダー出力との相互作用

4. **予測ヘッド**
   - 分類ヘッド: 91クラス + 背景
   - バウンディングボックスヘッド: 4次元 (中心x, y, 幅, 高さ)

### 重要な特徴

#### End-to-End学習
- **NMS不要**: 従来のNon-Maximum Suppressionが不要
- **アンカーボックス不要**: 事前定義されたアンカーボックスが不要
- **直接予測**: 物体の位置とクラスを直接予測

#### セット予測
- **固定クエリ数**: 100個のオブジェクトクエリ
- **二部マッチング**: 予測と正解の最適な対応付け
- **一意性保証**: 各物体に対して一つの予測のみ

#### Transformer活用
- **グローバルコンテキスト**: 画像全体の情報を活用
- **並列処理**: 全ての物体を同時に予測
- **スケーラビリティ**: 大規模データセットでの学習

### 損失関数

DETRは以下の損失関数を使用します：

1. **分類損失**: クロスエントロピー損失
2. **バウンディングボックス損失**: L1損失 + Generalized IoU損失
3. **二部マッチング損失**: Hungarian algorithmによる最適マッチング

```
L = λ_cls * L_cls + λ_box * L_box
```

### サポートされているモデル

- **facebook/detr-resnet-50**: ResNet-50バックボーン、物体検知
- **facebook/detr-resnet-101**: ResNet-101バックボーン、物体検知
- **facebook/detr-resnet-50-panoptic**: ResNet-50バックボーン、パノプティックセグメンテーション

## 📊 可視化機能

### 1. 物体検知可視化
- **バウンディングボックス**: 検知された物体の境界ボックス
- **クラスラベル**: 物体のクラス名と信頼度
- **色分け**: クラス別の色分け表示
- **統計情報**: 検知数、平均信頼度、クラス分布

### 2. アテンション可視化
- **ヒートマップ**: アテンション重みの2次元表示
- **レイヤー別分析**: 各Transformer層のアテンション
- **統計分析**: アテンション重みの分布と統計
- **インタラクティブ**: レイヤーとタイプの選択

### 3. クエリ分析
- **信頼度分布**: 100個のクエリの信頼度分布
- **トップ予測**: 最も信頼度の高いクエリ
- **クラス分布**: 予測されたクラスの分布
- **埋め込み統計**: クエリ埋め込みの統計情報

### 4. アーキテクチャ図
- **構造図**: DETRの全体的な構造
- **データフロー**: 画像から予測までの流れ
- **コンポーネント**: 各モジュールの役割
- **パラメータ**: モデルの設定情報

## 🐛 トラブルシューティング

### よくある問題

1. **モデル読み込みエラー**
   - Transformersライブラリが正しくインストールされているか確認
   - インターネット接続を確認（初回ダウンロード時）
   - GPUメモリが十分か確認

2. **メモリ不足エラー**
   - 画像サイズを小さくする
   - バッチサイズを1に設定
   - GPUメモリを確認

3. **アテンション可視化エラー**
   - モデルが正しく読み込まれているか確認
   - 画像が選択されているか確認
   - 十分なメモリがあるか確認

4. **依存関係エラー**
   - `uv sync` または `pip install -r requirements.txt` を実行
   - Pythonバージョンが3.8以上か確認
   - PyTorchとTransformersのバージョン互換性を確認

### デバッグ情報

デバッグ情報タブで以下を確認できます：
- モデルの詳細設定
- システム情報
- GPUメモリ使用量
- 生データの形状と内容

## 🔄 更新履歴

### v0.1.0 (2025-08-04)
- 初期リリース
- DETRモデルの実装
- 物体検知機能
- アテンション可視化
- クエリ分析
- アーキテクチャ図
- 内部状態分析
- デバッグ情報タブ

## 🤝 貢献

1. このリポジトリをフォーク
2. 機能ブランチを作成 (`git checkout -b feature/amazing-feature`)
3. 変更をコミット (`git commit -m 'Add amazing feature'`)
4. ブランチにプッシュ (`git push origin feature/amazing-feature`)
5. プルリクエストを作成

## 📄 ライセンス

このプロジェクトはMITライセンスの下で公開されています。詳細は[LICENSE](LICENSE)ファイルを参照してください。

## 📞 サポート

問題や質問がある場合は、以下までお問い合わせください：
- GitHub Issues: [プロジェクトのIssuesページ](https://github.com/your-username/detr-app/issues)


##  謝辞

- [DETR論文](https://arxiv.org/abs/2005.12872)の著者
- [Hugging Face Transformers](https://huggingface.co/docs/transformers/model_doc/detr)開発チーム
- [PyTorch](https://pytorch.org/)開発チーム
- [Streamlit](https://streamlit.io/)開発チーム

## 📚 参考文献

1. Carion, N., Massa, F., Synnaeve, G., Usunier, N., Kirillov, A., & Zagoruyko, S. (2020). End-to-End Object Detection with Transformers. *ECCV 2020*.
2. Vaswani, A., Shazeer, N., Parmar, N., Uszkoreit, J., Jones, L., Gomez, A. N., ... & Polosukhin, I. (2017). Attention is all you need. *NIPS 2017*.
3. He, K., Zhang, X., Ren, S., & Sun, J. (2016). Deep residual learning for image recognition. *CVPR 2016*.

---

**Happy Object Detection with Transformers! 🎉** 
